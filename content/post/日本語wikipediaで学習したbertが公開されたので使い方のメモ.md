+++
title = "日本語Wikipediaで学習したBERTが公開されたので使い方のメモ"
date = 2020-06-17T07:34:00Z
updated = 2020-12-04T13:50:42Z
tags = ["技術系"]
blogimport = true 
[author]
	name = "サブカル科学研究会"
	uri = "https://draft.blogger.com/profile/00849312168396849001"
+++

<head>      <meta charset="utf-8">      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/monokai-sublime.min.css" integrity="sha256-kTdkFYZP3TqSvlJAUiZ6/s5L2xu4xsdU9eYMWsKOk74=" crossorigin="anonymous">			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css" integrity="sha256-HbgiGHMLxHZ3kkAiixyvnaaZFNjNWLYKD/QG6PWaQPc=" crossorigin="anonymous">			<link rel="stylesheet" href="/css/guest.bundle.css?v=0.13.0"><style type="text/css">      .markdown-body { 			  box-sizing: border-box; 			  min-width: 200px; 			  max-width: 980px; 			  margin: 0 auto; 			  padding: 45px; 			} 			.markdown-body pre { 			  background: #23241f; 			} 			.markdown-body strong, 			.markdown-body h1, 			.markdown-body h2, 			.markdown-body h3, 			.markdown-body h4, 			.markdown-body h5 { 			  font-weight: 700; 			} 			@media (max-width: 767px) { 			  .markdown-body { 			    padding: 15px; 			  } 			}</style><script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><title>日本語Wikipediaで学習したBERTが公開されたので使い方のメモ</title></head><body><div class="markdown-body"><h1 id="日本語Wikipediaで学習したBERTが公開されたので使い方のメモ" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">日本語Wikipediaで学習したBERTが公開されたので使い方のメモ<a href="#日本語Wikipediaで学習したBERTが公開されたので使い方のメモ" title="日本語Wikipediaで学習したBERTが公開されたので使い方のメモ"><i class="fas fa-link ml-1" style="display:none;"></i></a></h1><ul><li><a href='#前準備:mecabのインストール'>前準備:mecabのインストール</a></li><li><a href='#transformersのインストール'>transformersのインストール</a></li><li><a href='#BERT_の利用方法については下記の例を参考にします。'>BERT の利用方法については下記の例を参考にします。</a></li><li><a href='#応用範囲'>応用範囲</a></li></ul> <p>huggingface がBERTの日本語モデルを公開しました。</p><p>日本語モデルはtransformersに含まれています。</p><p>しかし、Mac 環境で実際に動かすまでにいくつか躓いたので、メモを残しておきます。</p><h2 id="前準備:mecabのインストール" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">前準備:mecabのインストール<a href="#前準備:mecabのインストール" title="前準備:mecabのインストール"><i class="fas fa-link ml-1" style="display:none;"></i></a></h2><p>形態素解析エンジンであるmecabが BERT の日本語モデルを利用する際に必要になります。おそらくトークナイザがmecabを要求する仕組みになっています。</p><p>以下のサイトを参考にmecabをインストールします。</p><p>MecabをPythonで使うまで - QiitaMecabとは 形態素解析エンジンです。 形態素解析については他の方の記事がすごくわかりやすいので割愛します。 なお qiita.com</p><p>homebrew を利用して、Mecab とipadicをインストールします。</p><pre><code>brew install mecab mecab-ipadic</code></pre><p>辞書を更新するために、適当な辞書用のディレクトリを作成し、以下のコマンドを実行します。</p><pre><code>git clone --depth 1 https://github.com/neologd/mecab-ipadic-neologd.git<br />./bin/install-mecab-ipadic-neologd -n -a</code></pre><p>python のmecabラッパーをインストールします。</p><pre><code>pip install mecab-python3</code></pre><h2 id="transformersのインストール" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">transformersのインストール<a href="#transformersのインストール" title="transformersのインストール"><i class="fas fa-link ml-1" style="display:none;"></i></a></h2><p><a href="https://github.com/huggingface/transformers">huggingface/transformers</a></p><p>公式のドキュメントに従ってtransformersをインストールします。</p><pre><code>pip install transformers</code></pre><h2 id="BERT_の利用方法については下記の例を参考にします。" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">BERT の利用方法については下記の例を参考にします。<a href="#BERT_の利用方法については下記の例を参考にします。" title="BERT_の利用方法については下記の例を参考にします。"><i class="fas fa-link ml-1" style="display:none;"></i></a></h2><p><a href="https://github.com/cl-tohoku/bert-japanese">clｰtohoku</a></p><pre><code>import torch<br />from transformers.tokenization_bert_japanese import BertJapaneseTokenizer<br />from transformers.modeling_bert import BertForMaskedLM<br />tokenizer = BertJapaneseTokenizer.from_pretrained(&#39;bert-base-japanese-whole-word-masking</code></pre><p>bert-base-japanese-whole-word-maskingは学習時に用いたトークナイズの方法(単語区切りか文字区切り)を指定しています。</p><pre><code>model = BertForMaskedLM.from_pretrained(&#39;bert-base-japanese-whole-word-masking&#39;)</code></pre><p>タスクに対応したBERTモデルを読み込みます。</p><p>今回はMLM(Masked Language Model )となります。マスクトークンが存在する位置に入る単語の確率を返します。</p><pre><code>input_ids = tokenizer.encode(f&#39;&#39;&#39;<br />   青葉山で{tokenizer.mask_token}の研究をしています。<br />&#39;&#39;&#39;, return_tensors=&#39;pt&#39;)</code></pre><p>トークナイザを利用して、トークンを対応する辞書番号に変換します。</p><pre><code>print(input_ids)<br />print(tokenizer.convert_ids_to_tokens(input_ids[0].tolist()))</code></pre><p>id番号を対応する辞書のトークンに置き換えます。</p><pre><code>masked_index = torch.where(input_ids == tokenizer.mask_token_id)[1].tolist()[0]<br />print(masked_index)<br />result = model(input_ids)<br />pred_ids = result[0][:, masked_index].topk(5).indices.tolist()[0]<br />for pred_id in pred_ids:<br />   output_ids = input_ids.tolist()[0]<br />   output_ids[masked_index] = pred_id<br />   print(tokenizer.decode(output_ids))</code></pre><p>マスクトークンが入っている位置に入る確率が高いトークンをk=5個表示します。</p><p>BERT のモデルを指定することで、単語の確率だけでなく、分散表現も計算できます。</p><h2 id="応用範囲" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">応用範囲<a href="#応用範囲" title="応用範囲"><i class="fas fa-link ml-1" style="display:none;"></i></a></h2><p>単語の分散表現の応用範囲は以下のリンク</p><p><a href="https://www.subcul-science.com/2020/06/blog-post_54.html">文書分類問題の応用は何がある？</a></p></div></body><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><script>		  $(document).on("mouseover", "h1,h2,h3,h4,h5", function(e) { 		    $(e.currentTarget).find(".fa-link").text("🔗").show(); 		  }); 		  $(document).on("mouseout", "h1,h2,h3,h4,h5", function(e) { 		    $(e.currentTarget).find(".fa-link").hide(); 		  });</script> 参考資料  機械学習・深層学習による自然言語処理入門　scikit-learnとTensorFlowを使った実践プログラミング  <div class="booklink-box" style="text-align:left;padding-bottom:20px;font-size:small;zoom: 1;overflow: hidden;"><div class="booklink-image" style="float:left;margin:0 15px 10px 0;"><a href="//af.moshimo.com/af/c/click?a_id=2220302&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=https%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4839966605" target="_blank" ><img src="" style="border: none;" /></a><img src="//i.moshimo.com/af/i/impression?a_id=2220302&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none;"></div><div class="booklink-info" style="line-height:120%;zoom: 1;overflow: hidden;"><div class="booklink-name" style="margin-bottom:10px;line-height:120%"><a href="//af.moshimo.com/af/c/click?a_id=2220302&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=https%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4839966605" target="_blank" ></a><img src="//i.moshimo.com/af/i/impression?a_id=2220302&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none;"><div class="booklink-powered-date" style="font-size:8pt;margin-top:5px;font-family:verdana;line-height:120%">posted with <a href="https://yomereba.com" rel="nofollow" target="_blank">ヨメレバ</a></div></div><div class="booklink-detail" style="margin-bottom:5px;"></div><div class="booklink-link2" style="margin-top:10px;"><div class="shoplinkamazon" style="display:inline;margin-right:5px;background: url('//img.yomereba.com/yl.gif') 0 0 no-repeat;padding: 2px 0 2px 18px;white-space: nowrap;"><a href="//af.moshimo.com/af/c/click?a_id=2220302&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=https%3A%2F%2Fwww.amazon.co.jp%2Fexec%2Fobidos%2FASIN%2F4839966605" target="_blank" >Amazonで購入</a><img src="//i.moshimo.com/af/i/impression?a_id=2220302&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none;"></div><div class="shoplinkkindle" style="display:inline;margin-right:5px;background: url('//img.yomereba.com/yl.gif') 0 0 no-repeat;padding: 2px 0 2px 18px;white-space: nowrap;"><a href="//af.moshimo.com/af/c/click?a_id=2220302&p_id=170&pc_id=185&pl_id=4062&s_v=b5Rz2P0601xu&url=https%3A%2F%2Fwww.amazon.co.jp%2Fgp%2Fsearch%3Fkeywords%3D%26__mk_ja_JP%3D%2583J%2583%255E%2583J%2583i%26url%3Dnode%253D2275256051" target="_blank" >Kindleで購入</a><img src="//i.moshimo.com/af/i/impression?a_id=2220302&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none;"></div><div class="shoplinkrakuten" style="display:inline;margin-right:5px;background: url('//img.yomereba.com/yl.gif') 0 -50px no-repeat;padding: 2px 0 2px 18px;white-space: nowrap;"><a href="//af.moshimo.com/af/c/click?a_id=2220301&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=http%3A%2F%2Fbooks.rakuten.co.jp%2Frb%2F16190713%2F" target="_blank" >楽天ブックスで購入</a><img src="//i.moshimo.com/af/i/impression?a_id=2220302&p_id=170&pc_id=185&pl_id=4062" width="1" height="1" style="border:none;"></div><div class="shoplinkrakukobo" style="display:inline;margin-right:5px;background: url('//img.yomereba.com/yl.gif') 0 -50px no-repeat;padding: 2px 0 2px 18px;white-space: nowrap;"><a href="//af.moshimo.com/af/c/click?a_id=2220301&p_id=56&pc_id=56&pl_id=637&s_v=b5Rz2P0601xu&url=https%3A%2F%2Fbooks.rakuten.co.jp%2Frk%2F350e869d324d356eb91b3b52d00d0e36%2F" target="_blank" >楽天koboで購入</a><img src="//i.moshimo.com/af/i/impression?a_id=2220301&p_id=56&pc_id=56&pl_id=637" width="1" height="1" style="border:none;"></div>	  <div class="shoplinkseven" style="display:inline;margin-right:5px;background: url('//img.yomereba.com/yl.gif') 0 -100px no-repeat;padding: 2px 0 2px 18px;white-space: nowrap;"><a href="//af.moshimo.com/af/c/click?a_id=2317554&p_id=932&pc_id=1188&pl_id=12456&s_v=b5Rz2P0601xu&url=http%3A%2F%2F7net.omni7.jp%2Fsearch%2F%3FsearchKeywordFlg%3D1%26keyword%3D9784839966607" target="_blank" >7netで購入<img src="//i.moshimo.com/af/i/impression?a_id=2317554&p_id=932&pc_id=1188&pl_id=12456" width="1" height="1" style="border:none;"></a></div>            	  	  	  	      </div></div><div class="booklink-footer" style="clear: left"></div></div>
