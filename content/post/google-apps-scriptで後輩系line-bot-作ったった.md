+++
title = "Google Apps Scriptで後輩系line bot 作ったった"
date = 2020-06-25T03:55:00Z
updated = 2020-07-11T14:40:45Z
tags = ["技術系"]
blogimport = true 
[author]
	name = "サブカル科学研究会"
	uri = "https://draft.blogger.com/profile/00849312168396849001"
+++

<html><head>      <meta charset="utf-8">      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/monokai-sublime.min.css" integrity="sha256-kTdkFYZP3TqSvlJAUiZ6/s5L2xu4xsdU9eYMWsKOk74=" crossorigin="anonymous">			<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css" integrity="sha256-HbgiGHMLxHZ3kkAiixyvnaaZFNjNWLYKD/QG6PWaQPc=" crossorigin="anonymous">			<link rel="stylesheet" href="/css/guest.bundle.css?v=0.13.0"><style type="text/css">      .markdown-body { 			  box-sizing: border-box; 			  min-width: 200px; 			  max-width: 980px; 			  margin: 0 auto; 			  padding: 45px; 			} 			.markdown-body pre { 			  background: #23241f; 			} 			.markdown-body strong, 			.markdown-body h1, 			.markdown-body h2, 			.markdown-body h3, 			.markdown-body h4, 			.markdown-body h5 { 			  font-weight: 700; 			} 			@media (max-width: 767px) { 			  .markdown-body { 			    padding: 15px; 			  } 			}</style><script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><title>Google Apps Scriptで後輩系line bot 作ったった</title></head><body><div class="markdown-body"><h1 id="Google_Apps_Scriptで後輩系line_bot_作ったった_" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">Google Apps Scriptで後輩系line bot 作ったった　<a href="#Google_Apps_Scriptで後輩系line_bot_作ったった_" title="Google_Apps_Scriptで後輩系line_bot_作ったった_"><i class="fas fa-link ml-1" style="display:none;"></i></a></h1><p>そういえばLINE botを個人開発したことがありました！</p><p>目次</p><ul><li><a href='#動機'>動機</a></li><li><a href='#botの概要'>botの概要</a></li><li><a href='#サンプルコード'>サンプルコード</a></li><li><a href='#結果'>結果</a></li></ul> <h2 id="動機" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">動機<a href="#動機" title="動機"><i class="fas fa-link ml-1" style="display:none;"></i></a></h2><p>当時、仲間内でDTMが流行りまして、作った曲を共有するためにGoogleドライブを利用してました。</p><p>ですが、こっそりアップするシャイなメンバーが多かったので、曲のアップを見逃すことが多かったんですね。</p><p>そこでGoogleドライブの共有フォルダに更新があったら教えてくれるヤツあったら見落としが減っていいだろうな、という動機でbot作成に着手しました。</p><p>あれは完全に自分に需要があるという理由で作ったけど、よく作れたなと思います。</p><h2 id="botの概要" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">botの概要<a href="#botの概要" title="botの概要"><i class="fas fa-link ml-1" style="display:none;"></i></a></h2><p>定期的に共有フォルダの更新をチェックして、更新があればそのファイルのリンクをLINEグループに投稿してくれるものです。</p><p>LINE botはGASを使ってサーバーレスの仕様にしたので、今でも動いています。</p><p>たまに共有フォルダにファイルをアップすると通知してくれます。</p><p>ファイル名とリンクと曲をアップしたことへのねぎらいの一言があって、個人的にはbotというよりはキャラクターなんですよね。</p><p>当時FGOにハマっていたので後輩系のキャラなんです。</p><h2 id="サンプルコード" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">サンプルコード<a href="#サンプルコード" title="サンプルコード"><i class="fas fa-link ml-1" style="display:none;"></i></a></h2><p>Googleドライブとラインの設定は以下のリンクを参考にしました。</p><ul><li><p><a href="https://qiita.com/hakshu/items/55c2584cf82718f47464">Google  Apps  ScriptでLINE  BOTつくったら30分で動かせた件</a></p></li><li><p><a href="https://boomin.yokohama/archives/797">【ソースコード付き】GoogleDriveでファイルが追加・更新されたらメールで通知する</a></p></li></ul><p>上記のリンクを参考に下記のコードの穴埋めをすることでline  botを実装できます。</p><p>下記の部分で変数の設定を行います。</p><ul><li><p>bangdore_FOLDER_ID</p><p>  Googleドライブの更新をチェックしたいディレクトリのID。</p></li></ul><ul><li><p>SEND_MAIL_ADDRESS</p><p>  更新通知を送りたいメールアドレス。</p></li><li><p>access_token</p><p>  line  developersのアクセストークン</p></li></ul><pre><code>var bangdore_FOLDER_ID = &#39;google drive directoy id&#39;;<br />var SEND_MAIL_ADDRESS = [&#39;eｰmail＠dot.com&#39;];<br />var ADD_FILE_COUNT = 0;<br />var ADD_FOLDER_COUNT = 0;<br />var lastUpdateMap = {};<br />var lastUpdate = 0<br />var updateFileList = [];<br />var updateFileLinkList = [];<br />var day_ago_unix_time = 0<br /><br />//Time is processed by minute<br />var msecPerMinute = 1000 * 60;<br />var SEARCH_TIME = 100;<br /><br />var access_token = &quot;hogehoge&quot;;<br /></code></pre><p>スクリプトの起動を通知するためにメールを送る関数。別になくても動きます。</p><pre><code>function sendMail(){<br />  SEND_MAIL_ADDRESS.forEach(function(o,i) {<br />    MailApp.sendEmail(SEND_MAIL_ADDRESS[i],&quot;バンドリチェッカー起動通知&quot;, &quot;run bandre checker&quot;<br />                     );<br />  })<br />}</code></pre><p>lineにメッセージを送るための関数。</p><pre><code>function sendHttpPost(message){<br />  var token = [access_token];<br />  Logger.log(&#39;token &#39;+token);<br />  var options =<br />      {<br />        &quot;method&quot;  : &quot;POST&quot;,<br />        &quot;payload&quot; : &quot;message=&quot; + message,<br />        &quot;headers&quot; : {&quot;Authorization&quot; : &quot;Bearer &quot;+ token}<br /><br />  };<br />UrlFetchApp.fetch(&quot;https://notify-api.line.me/api/notify&quot;,options);<br />}<br /></code></pre><p>Googleドライブのフォルダ内のファイルを全てサーチして、更新時間を取得する部分。</p><p>もっとエレガントな実装があるとは思うので、あくまで参考程度に。</p><pre><code>function stackFiles(file){<br />  updateFileList.push(file.getName());<br />  updateFileLinkList.push(file.getUrl());<br />  lastUpdate = createdTime;<br />  ADD_FILE_COUNT++;<br />}<br /><br />function DeepFolder(bangdoreFolder){<br />  Logger.log(&#39;deep folder&#39;)<br />  var deepFolder = bangdoreFolder.getFolders();<br />  while (deepFolder.hasNext()){<br />    var folder = deepFolder.next()<br />    Logger.log(&quot;folder names are &quot;+folder.getName())<br />    DeepFolder(folder);<br />    var files = folder.getFiles();<br /><br />    while (files.hasNext()) {<br />      var file = files.next();<br />      createdTime = Utilities.formatDate( file.getLastUpdated(), &#39;Asia/Tokyo&#39;, &#39;yyyyMMddHHmm&#39;);<br />      if(day_ago_unix_time &lt; createdTime){<br />        stackFiles(file)<br />      }<br />    }<br />    ADD_FOLDER_COUNT++;<br />  }<br />}</code></pre><p>botがランダムで挨拶をしてくれる部分。</p><p>ここを変えるとキャラ付けが変わる。</p><p>今回は心配性な後輩キャラ。マ○ュにインスパイアされました。</p><pre><code>function greeting(){<br />  var results=[&quot;一緒にがんばりましょうね&quot;,&quot;無理は禁物ですよ&quot;,&quot;お茶でも飲みませんか？&quot;,&quot;私はちゃんと分かってますから&quot;,&quot;食事はきちんと取りましょうね&quot;,&quot;頑張ってますね&quot;,&quot;いい加減にしましょうね？&quot;];<br />  var greet = results[Math.floor(Math.random()*results.length)]<br />  Logger.log(greet);<br />  return greet;<br />}</code></pre><p>実際のメイン関数。</p><p>更新されたファイルのリンクをメッセージとしてlineに投稿します。</p><pre><code>function main() {<br />  //sendMail()<br />  var dateobj = new Date();<br />  var now_unix_time =  Utilities.formatDate(dateobj, &#39;Asia/Tokyo&#39;, &#39;yyyyMMddHHmm&#39;);<br />  Logger.log(&quot;now_unix_time&quot;+now_unix_time)<br />  //How to show the time SEARCH_TIME minutes before from now....?<br />  day_ago_unix_time = now_unix_time - SEARCH_TIME;<br /><br />  var bangdoreFolder = DriveApp.getFolderById(bangdore_FOLDER_ID);<br />  var files = bangdoreFolder.getFiles();  <br /><br />  while (files.hasNext()) {<br />    var file = files.next();<br />    createdTime = Utilities.formatDate( file.getLastUpdated(), &#39;Asia/Tokyo&#39;, &#39;yyyyMMddHHmm&#39;);<br />    if(day_ago_unix_time &lt; createdTime){<br />      stackFiles(file)<br />    }    <br />  }<br /><br />  DeepFolder(bangdoreFolder);<br />  Logger.log(&quot;day_ago_unix_time &quot;+day_ago_unix_time);<br />  var min_update_time = 0;<br /><br />  if(lastUpdate &gt; day_ago_unix_time) {<br />    Logger.log(&quot;There are renewed files &quot;)<br />    SEND_MAIL_ADDRESS.forEach(function(o,i) {<br />      MailApp.sendEmail(SEND_MAIL_ADDRESS[i],&quot;更新通知&quot;,<br />                        &quot;譜面が&quot; + ADD_FILE_COUNT + &quot;枚更新されたよ！&quot; + &quot;\n\n&quot; +<br />                        &quot;URLはこちら↓&quot; + &quot;\n&quot; +<br />                        &quot;https://drive.google.com/open?id=&quot; + bangdore_FOLDER_ID + &quot;\n\n&quot; +<br />                        &quot;更新された譜面のリンク\n&quot;+<br />                        updateFileList.join(&quot;\n&quot;)<br />      );<br />    })<br /><br />    var message = &quot;更新ですよ、先輩\n\n&quot;;<br />    Logger.log(&quot;renewed &quot;+updateFileList);<br />    for(var i=0; i&lt;updateFileList.length; i++){<br />      var name = updateFileList[i];<br />      var link = updateFileLinkList[i];<br />      Logger.log(&quot;renew file &quot;+name);<br />      message = message + name + &quot;\n&quot;;<br />      message = message + link + &quot;\n\n&quot;;<br />    };<br />    message = message + &quot;以上です\n&quot;;<br />    message = message + greeting();<br />    Logger.log(message)<br />    sendHttpPost(message);<br />  }<br />  else{<br />    Logger.log(&quot;There are no renewed files &quot;);<br />  }<br />  Logger.log(&quot;The number of renewed files &quot;+ADD_FILE_COUNT);<br />  Logger.log(&quot;The number of renewed folders &quot;+ADD_FOLDER_COUNT);<br />}<br /></code></pre><h2 id="結果" onmouseover="this.querySelector('a .fa-link').style.display='inline-block'" onmouseout="this.querySelector('a .fa-link').style.display='none'">結果<a href="#結果" title="結果"><i class="fas fa-link ml-1" style="display:none;"></i></a></h2><p>結局はメンバーの熱が冷めて、活躍の場面も無くなっていきました。メンバーのエンゲージメントを保つのは難しいですね。</p><p>グループでメンバーが活動しやすいように、作曲に対してリアクションがあると嬉しいんじゃないかな！という想いを込めてLINE bot にねぎらいの一言を添えるようにしました。</p><p>だけど、それはメンバーのモチベーションには繋がらなかったようです。</p><p>botを可愛がってもらえるようにするには各メンバーの好みを把握するのは次回に活かします。</p></div></body><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js" integrity="sha256-aYTdUrn6Ow1DDgh5JTc3aDGnnju48y/1c8s1dgkYPQ8=" crossorigin="anonymous"></script><script type="text/javascript">hljs.initHighlightingOnLoad();</script><script>		  $(document).on("mouseover", "h1,h2,h3,h4,h5", function(e) { 		    $(e.currentTarget).find(".fa-link").text("🔗").show(); 		  }); 		  $(document).on("mouseout", "h1,h2,h3,h4,h5", function(e) { 		    $(e.currentTarget).find(".fa-link").hide(); 		  });</script></html>
